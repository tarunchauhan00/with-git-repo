<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Docs CMS</title>
  <style>
    body { font-family:sans-serif; padding:2rem; }
    #controls { max-width:500px; margin:auto; text-align:center; }
    button { padding:.75rem; margin:.5rem; width:45%; }
    #project-list { margin-top:2rem; }
    #project-list li { cursor:pointer; padding:.5rem; border-bottom:1px solid #eee; }
    #nc-root { margin-top:2rem; display:none; }
  </style>
</head>
<body>
  <div id="controls">
    <h2>ðŸ“˜ Documentation CMS</h2>
    <button id="newBtn">Create New Project</button>
    <ul id="project-list"></ul>
  </div>
  <div id="nc-root"></div>

  <script>window.CMS_MANUAL_INIT = true;</script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>

  <script>
    const listEl = document.getElementById("project-list");

    // 1) Fetch and render existing projects
    async function fetchProjects() {
      const res = await fetch("/.netlify/functions/list-projects");
      const projects = await res.json();
      listEl.innerHTML = projects
        .map(p => `<li data-repo="${p.repo}">${p.repo}Â â€“Â ${new Date(p.created_at).toLocaleString()}</li>`)
        .join("");
      listEl.querySelectorAll("li").forEach(li => {
        li.onclick = () => loadCMS(li.dataset.repo);
      });
    }

    // 2) Prompt for GitHub URL, init MkDocs, then reload list & open CMS
    async function createNew() {
      const url = prompt("Paste GitHub repo URL (org/repo or full URL):");
      if (!url) return;
      const repo = url.replace(/^.*github\.com\//, "").replace(/\.git$/, "");
      try {
        await fetch("/.netlify/functions/init-repo", {
          method: "POST",
          body: JSON.stringify({ repo })
        }).then(r => r.ok ? r.json() : Promise.reject(r));
        await fetchProjects();
        loadCMS(repo);
      } catch (e) {
        const err = await e.text?.() || e.message;
        alert("Error: " + err);
        console.error(e);
      }
    }

    document.getElementById("newBtn").onclick = createNew;

    function loadCMS(repo) {
      document.getElementById("controls").style.display = "none";
      document.getElementById("nc-root").style.display = "block";
      netlifyIdentity.init({ open_signup: true });
      netlifyIdentity.on("init", user => user || netlifyIdentity.open());
      CMS.init({
        config: {
          backend: { name: "git-gateway", repo, branch: "main" },
          media_folder: "docs/images", public_folder: "/images",
          collections: [{
            name: "pages", label: "Pages",
            folder: "docs", create: true, slug: "{{slug}}",
            fields: [
              { label: "Title", name: "title", widget: "string" },
              { label: "Body", name: "body", widget: "markdown" }
            ]
          }]
        },
        root: document.getElementById("nc-root")
      });
    }

    // initial load
    fetchProjects();
  </script>
</body>
</html>
