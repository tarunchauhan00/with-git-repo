<!-- admin/index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Documentation CMS</title>
  <base href="/" />
  <style>
    body { font-family: sans-serif; padding: 2rem; text-align: center; }
    #controls { max-width: 400px; margin: auto; }
    #controls button { padding: .75rem; margin: .5rem 0; width: 100%; }
    #nc-root { margin-top: 2rem; }
  </style>
</head>
<body>
  <div id="controls">
    <h2>📘 Documentation CMS</h2>
    <button id="defaultBtn">Continue with Default Project</button>
    <button id="newBtn">Create New Project</button>
  </div>
  <div id="nc-root" style="display: none;"></div>

  <script>window.CMS_MANUAL_INIT = true;</script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://unpkg.com/netlify-cms@^2.10.0/dist/netlify-cms.js"></script>
  <script>
    // your “default” docs repo (owner/name)
    const defaultRepo = "https://github.com/tarunchauhan00/with-git-repo";  

    async function createRepo(name) {
      const res = await fetch('/.netlify/functions/create-repo', {
        method: 'POST',
        body: JSON.stringify({ name })
      });
      const text = await res.text();
      if (!res.ok) throw new Error(text);
      const json = JSON.parse(text);
      return `${json.org}/${json.repo}`;
    }

    function loadCMS(repo) {
      document.getElementById('controls').style.display = 'none';
      document.getElementById('nc-root').style.display    = 'block';

      netlifyIdentity.init({ open_signup: true });
      netlifyIdentity.on('init', user => user || netlifyIdentity.open());

      CMS.init({
        config: {
          backend: {
            name:   'git-gateway',
            repo:   repo,        // ← dynamically point at this repo
            branch: 'main'
          },
          media_folder: 'docs/images',
          public_folder: '/images',
          collections: [{
            name:   'pages',
            label:  'Pages',
            folder: 'docs',
            create: true,
            slug:   '{{slug}}',
            fields: [
              { label: 'Title', name: 'title', widget: 'string' },
              { label: 'Body',  name: 'body',  widget: 'markdown' }
            ]
          }]
        },
        root: document.getElementById('nc-root')
      });
    }

    document.getElementById('defaultBtn').onclick = () => loadCMS(defaultRepo);

    document.getElementById('newBtn').onclick = async () => {
      const name = prompt('New repo name (no spaces):', 'my-new-docs');
      if (!name) return;
      try {
        const repo = await createRepo(name);
        loadCMS(repo);
      } catch (err) {
        alert('Error creating repo: ' + err.message);
        console.error('createRepo error:', err);
      }
    };
  </script>
</body>
</html>
